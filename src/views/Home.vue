<template>
    <div class="home">
      <!--  Results Modal  -->
      <v-dialog v-model="finished" fullscreen hide-overlay transition="dialog-bottom-transition">
        <v-card>
          <div class="color-header"></div>
          <v-toolbar flat color="grey" class="lighten-5">
                  <div class="d-flex align-center">
                    <v-img
                      alt="MAL2 Logo"
                      class="shrink mr-2"
                      contain
                      :src="require('../assets/logo_header.png')"
                      transition="scale-transition"
                      width="40"
                    />
                  MAL2APK
            </div>
            <v-spacer></v-spacer>
            {{$t('message.results_for')}} {{file.name}}
          </v-toolbar>
          <v-toolbar flat color="white" style="margin-top: 30px">
            <v-progress-circular :value="percent" :color="color" size="100" width="10" rotate="-90" style="margin-left: 2em">{{positives}}/5</v-progress-circular>
            <v-alert :type="alertType" width="80%" style="margin-left: 5%" :color="color">
              {{positives}} {{$t("message.engine")}}
            </v-alert>
          </v-toolbar>
          <v-simple-table style="padding: 2em">
            <template v-slot:default>
              <thead>
                <tr>
                  <th>Engine</th>
                  <th>Result</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Androguard</td>
                  <td style="font-weight: bold; color: red" v-if="result.classification.contains_malware_androguard">{{$t('message.found')}}</td>
                  <td style="font-weight: bold; color: green" v-else>OK</td>
                </tr>
                <tr>
                  <td>Ikarus</td>
                  <td style="font-weight: bold; color: red" v-if="result.classification.contains_malware_ikarus">{{$t('message.found')}}</td>
                  <td style="font-weight: bold; color: green" v-else>OK</td>
                </tr>
                <tr>
                  <td>Malware Rule Engine</td>
                  <td style="font-weight: bold; color: red" v-if="result.classification.contains_malware_rule_engine">{{$t('message.found')}}</td>
                  <td style="font-weight: bold; color: green" v-else>OK</td>
                </tr>
                <tr>
                  <td>Tracker Engine</td>
                  <td style="font-weight: bold; color: red" v-if="result.classification.contains_trackers">{{$t('message.found')}}</td>
                  <td style="font-weight: bold; color: green" v-else>OK</td>
                </tr>
                <tr>
                  <td>Adware Engine</td>
                  <td style="font-weight: bold; color: red" v-if="result.classification.contains_adware">{{$t('message.found')}}</td>
                  <td style="font-weight: bold; color: green" v-else>OK</td>
                </tr>
              </tbody>
            </template>
          </v-simple-table>
        <v-card-actions>
          <v-btn color="rgb(4, 47, 81)" dark @click="reset">{{$t('message.new_apk')}}</v-btn>
        </v-card-actions>
        </v-card>
      </v-dialog>
      <!-- Main Content -->
      <v-container
        class="fill-height"
        fluid
      >
        <v-row
          align="center"
          justify="center"
        >
          <v-col
            cols="12"
            sm="6"
            md="6"
          >
            <v-alert type="error" dense dismissible="true" v-if="serverError">{{$t('message.error')}}</v-alert>
            <v-alert type="error" dense dismissible="true" v-if="captchaError">{{$t('message.captcha_error')}}</v-alert>
            <p style="text-align: center; margin-bottom: 10em;">{{$t('message.description')}}</p>
            <v-card flat>
              <v-toolbar
                color="grey"
                class="lighten-5"
                flat
              >
                <v-spacer></v-spacer>
                <v-toolbar-title class="align-center" v-if="!loading">{{$t('message.card_header')}}</v-toolbar-title>
                <v-toolbar-title class="align-center" v-if="loading">{{$t('message.checking_apk')}} ({{time}}s)</v-toolbar-title>
                <v-spacer></v-spacer>
              </v-toolbar>
              <v-card-text>
                <v-img style="margin-left: 45%" :src="require('../assets/thumbprint.png')" width="70px" height="100px"></v-img>
                <p>long disclaimer text Lorem ipsum dolor sit amet, consectetur adipisicing elit. Amet architecto, beatae facere officia officiis provident reiciendis repellendus totam ut vel! Cupiditate dolor eos labore nostrum nulla quidem reprehenderit! Autem, sint.</p>
                <vue-recaptcha ref="recaptcha" sitekey="6Lf-Gc8ZAAAAAIImMprAK5q-_vsLbromLZ97KfcN" style="margin-left: 32.5%; margin-bottom: 30px;" @verify="onCaptchaVerified"></vue-recaptcha>
                <v-btn dark color="rgb(4, 47, 81)" class="submit-btn" @click="open" :loading="loading">{{$t('message.button')}}</v-btn>
                <input type="file" style="display: none" ref="file_input" accept=".apk" @change="handleFileUpload" loadRecaptchaScript="true" :language="$i18n.locale">
              </v-card-text>
              <v-card-actions>
              </v-card-actions>
            </v-card>
          </v-col>
        </v-row>
      </v-container>
      <v-footer style="position: absolute; bottom: 0;">
          <v-spacer></v-spacer>
          <div>&copy; <a href="https://x-net.at" style="color: black; text-decoration: none">X-NET {{new Date().getFullYear()}}</a> | <b>Version</b> 1.0.0</div>
      </v-footer>
    </div>
</template>

<script>
import axios from 'axios'
import VueRecaptcha from 'vue-recaptcha'
export default {
  name: 'Home',
  components: {
    VueRecaptcha
  },
  data(){
    return{
      file: '',
      loading: false,
      finished: false,
      intervall: {},
      positives: 0,
      time: 0,
      serverError: false,
      captchaError: false,
      noRobot: false,
      result: {
        classification: {

        }
      }
    }
  },
  methods:{
    // opens the result modal
    open(){
      this.$refs['file_input'].click()
    },
    // resets the whole app and closes the results modal
    reset(){
      this.positives = 0
      this.finished = false
      this.$refs.recaptcha.reset()
    },
    onCaptchaVerified(token){
      this.noRobot = true
      console.log(token)
    },
    // starts the request timer
    async startTimer(){
      this.intervall = setInterval(function (){
        this.time += 1
      }.bind(this), 1000)
    },
    // grabs the file field and uploads it to the api
    handleFileUpload(){
      if (this.noRobot) {
        //start the query timer
        this.startTimer()
        //upload the file
        this.loading = true
        this.file = this.$refs['file_input'].files[0]
        let formData = new FormData();
        formData.append('file', this.file)
        axios.post('http://marjorie.lo-res.org:8000/api/v1/upload/binary/', formData, {headers: {'Content-Type': 'multipart/form-data'}}).then(resp => {
          this.result = resp.data
          this.finished = true
          this.loading = false
        }).catch(error =>{
          console.log(error.response.data)
          this.serverError = true
          this.loading = false
        })
      } else {
        this.captchaError = true
      }
    }
  },
  computed: {
    // calculates the percent of positive malware findings and sets the positives variable
    percent () {
      // eslint-disable-next-line vue/no-side-effects-in-computed-properties
      this.positives = 0
      for (const [key, value] of Object.entries(this.result.classification)){
        console.log(key)
        if (value) {
          // eslint-disable-next-line vue/no-side-effects-in-computed-properties
          this.positives += 1
        }
      }
      return this.positives * 20
    },
    // calculates the color of the alert and the percent spinner
    color () {
      switch (this.positives){
        case 0:
          return 'green'
        case 1:
          return '#a6ff00'
        case 2:
          return '#ffb700'
        case 3:
          return 'orange'
        case 4:
          return '#ff3c00'
        default:
          return 'red'
      }
    },
    // calculates the type of the alert
    alertType () {
      switch (this.positives){
        case 0:
          return 'success'
        case 1:
          return 'warning'
        case 2:
          return 'warning'
        case 3:
          return 'warning'
        case 4:
          return 'warning'
        default:
          return 'error'
      }
    }
  }
}
</script>

<style>
  .submit-btn{
    margin-left: 40%;
  }
</style>
